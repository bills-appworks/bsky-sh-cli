#!/bin/sh
# Bluesky in the shell
# A Bluesky CLI (Command Line Interface) implementation in shell script
# Author Bluesky:@billsbs.bills-appworks.net
# 
# Copyright (c) 2024 bills-appworks
# This software is released under the MIT License.
# http://opensource.org/licenses/mit-license.php
FILE_DIR=`dirname "$0"`
FILE_DIR=`(cd "${FILE_DIR}" && pwd)`

BSKYSHCLI_CLI_VERSION='0.1.0'

# following definitions are same to lib/api/common.sh
# for independence of this bsky command

# global option (default value)
BSKYSHCLI_GLOBAL_OPTION_PROFILE=''

# $<variables> want to pass through for jq
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_POST_OUTPUT_ID='[uri:\($URI)] [cid:\($CID)]'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_POST_META='[ViewIndex:\($VIEW_INDEX)] VIEW_TEMPLATE_POST_OUTPUT_ID_PLACEHOLDER'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_POST_HEAD='\($AUTHOR_DISPLAYNAME)  @\($AUTHOR_HANDLE)  \($CREATED_AT)'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_POST_BODY='\($TEXT)'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_POST_TAIL='Reply:\($REPLY_COUNT) Repost:\($REPOST_COUNT) Like:\($LIKE_COUNT)'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_POST_SEPARATOR=''
BSKYSHCLI_VIEW_TEMPLATE_POST_OUTPUT_ID_PLACEHOLDER='VIEW_TEMPLATE_POST_OUTPUT_ID_PLACEHOLDER'
BSKYSHCLI_VIEW_TEMPLATE_QUOTE='| '
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_POST_FEED_GENERATOR_OUTPUT_ID='[uri:\($URI)] [cid:\($CID)] [did:\($DID)]'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_POST_FEED_GENERATOR_META='[custom feed (feed generator)] VIEW_TEMPLATE_POST_OUTPUT_ID_PLACEHOLDER'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_POST_FEED_GENERATOR_HEAD='\($DISPLAYNAME)\n  Feed by @\($CREATOR_HANDLE)'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_POST_FEED_GENERATOR_TAIL='Liked by \($LIKECOUNT) users'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_IMAGE=' [\($IMAGE_INDEX)] \($ALT)  \($FULLSIZE)'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_PROFILE='[avatar] \($AVATAR)\n[banner] \($BANNER)\n\($DISPLAYNAME)\n@\($HANDLE)\n\($FOLLOWERSCOUNT) followers  \($FOLLOWSCOUNT) follows  \($POSTSCOUNT) posts\n\($DESCRIPTION)'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_PROFILE_OUTPUT_ID='[avatar] \($AVATAR)\n[banner] \($BANNER)\n\($DISPLAYNAME)\n@\($HANDLE) (\($DID))\n\($FOLLOWERSCOUNT) followers  \($FOLLOWSCOUNT) follows  \($POSTSCOUNT) posts\n\($DESCRIPTION)'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_PROFILE_NAVI_COMMON='[posts]\n bsky author-feed --handle \($HANDLE) --filter posts-no-replies\n[replies]\n bsky author-feed --handle \($HANDLE) --filter posts-with-replies\n[media]\n bsky author-feed --handle \($HANDLE) --filter posts-with-media'
# shellcheck disable=SC2016
BSKYSHCLI_VIEW_TEMPLATE_PROFILE_NAVI_MYACCOUNT='[like]\n (not yet implemented)\n[feed]\n (not yet implemented)\n[list]\n (not yet implemented)'

BSKYSHCLI_DEFAULT_RESOURCE_CONFIG_PATH="${HOME}/.bsky_sh_cli_rc"
BSKYSHCLI_DEFAULT_TOOLS_WORK_DIR="${HOME}/.bsky_sh_cli"
BSKYSHCLI_DEFAULT_TOOLS_ROOT_DIR="${FILE_DIR}/.."
BSKYSHCLI_DEFAULT_TOOLS_ROOT_DIR=`(cd "${BSKYSHCLI_DEFAULT_TOOLS_ROOT_DIR}" && pwd)`
BSKYSHCLI_DEFAULT_LIB_PATH="${BSKYSHCLI_DEFAULT_TOOLS_ROOT_DIR}/lib"

# read resource config
if [ -z "${BSKYSHCLI_RESOURCE_CONFIG_PATH}" ]
then
  BSKYSHCLI_RESOURCE_CONFIG_PATH="${BSKYSHCLI_DEFAULT_RESOURCE_CONFIG_PATH}"
fi
export BSKYSHCLI_RESOURCE_CONFIG_PATH
if [ -r "${BSKYSHCLI_RESOURCE_CONFIG_PATH}" ]
then
  # SC1090 disable for resource config file generize on runtime
  # shellcheck source=/dev/null
  . "${BSKYSHCLI_RESOURCE_CONFIG_PATH}"
fi

if [ -z "${BSKYSHCLI_TOOLS_WORK_DIR}" ]
then
  BSKYSHCLI_TOOLS_WORK_DIR="${BSKYSHCLI_DEFAULT_TOOLS_WORK_DIR}"
fi
export BSKYSHCLI_TOOLS_WORK_DIR
if [ -z "${BSKYSHCLI_TOOLS_ROOT_DIR}" ]
then
  BSKYSHCLI_TOOLS_ROOT_DIR="${BSKYSHCLI_DEFAULT_TOOLS_ROOT_DIR}"
fi
export BSKYSHCLI_TOOLS_ROOT_DIR
if [ -z "${BSKYSHCLI_LIB_PATH}" ]
then
  BSKYSHCLI_LIB_PATH="${BSKYSHCLI_DEFAULT_LIB_PATH}"
fi
export BSKYSHCLI_LIB_PATH
if [ -z "${BSKYSHCLI_API_PATH}" ]
then
  BSKYSHCLI_API_PATH="${BSKYSHCLI_LIB_PATH}/api"
fi
export BSKYSHCLI_API_PATH

UTILITY_PATH="${BSKYSHCLI_LIB_PATH}/util.sh"
if [ -r "${UTILITY_PATH}" ]
then
  # SC1090
  # shellcheck source=SCRIPTDIR/../lib/util.sh
  . "${UTILITY_PATH}"
else
  echo "tools internal configured file util.sh is not readable: ${UTILITY_PATH}"
  exit 1
fi
BSKY_CORE_PATH="${BSKYSHCLI_LIB_PATH}/bsky_core.sh"
if [ -r "${BSKY_CORE_PATH}" ]
then
  # SC1090
  # shellcheck source=SCRIPTDIR/../lib/bsky_core.sh
  . "${BSKY_CORE_PATH}"
else
  echo "tools internal configured file bsky_core.sh is not readable: ${BSKY_CORE_PATH}"
  exit 1
fi

# functions

output_help_general()
{
  debug 'output_help_general' 'START'

  cat << 'EOS'
bsky - A Bluesky CLI (Command Line Interface) implementation in shell script
usage: bsky [options] <command> [parameters]

global options:
  -P <profile>, --profile=<profile>
      specify session profile name. sessions coexist independently for each profile.

  --session-refresh
      forces a session refresh on command exectuion.

  --version
      show bsky CLI version. other options/command/parameters are ignored.

commands:
  login        login to Bluesky for create session.
  logout       logout from Bluesky for clear session.
  timeline     show timeline (now incomplete).
  feed         show custom feed (feed generator).
  author-feed  show author feed.
  post         post text.
  reply        reply to existing post.
  repost       reopst of existing post.
  quote        post by quoting an existing post.
  like         like on existing post.
  thread       show thread of specified post.
  profile      show profile.
  info         show session/meta informations.
  help         show this help.
  version      show bsky CLI version.

To see command help:
  bsky <command> help
EOS

  debug 'output_help_general' 'END'
}

output_help_login()
{
  debug 'output_help_login' 'START'

  cat << 'EOS'
bsky login command help'

usage: bsky login --handle <handle> --password <password>

parameters:
  --handle <handle>
    Specify Bluesky handle. Default domain (.bsky.social) can be omitted.

  --password <password>
    Specify the password corresponding to the handle.

note:
  A local file containing login session information is generated.
  Login session information is deleted using the logout command.
EOS

  debug 'output_help_login' 'END'
}

output_help_logout()
{
  debug 'output_help_logout' 'START'

  cat << 'EOS'
bsky logout command help

usage: bsky logout

parameters:
  none

note:
  Delete session and local files containing login session information.
EOS

  debug 'output_help_logout' 'END'
}

output_help_timeline()
{
  debug 'output_help_timeline' 'START'

  cat << 'EOS'
bsky timeline help

usage: bsky timeline [--limit <number>] [--next]

parameters:
  --limit <number>
    Specify limit number (default 50) of output feeds (from 1 to 100).

  --next
    Output next feeds from previous timeline command.

  --output-id
    Output identifier of AT protocol (uri, cid)

note:
  you must have started a Bluesky session with the login command.
EOS

  debug 'output_help_timeline' 'END'
}

output_help_feed()
{
  debug 'output_help_feed' 'START'

  cat << 'EOS'
bsky feed help

usage: bsky feed --actor <handle or did> --record-key <record key> [--limit <number>] [--next] [--output-id]
       or
       bsky feed --handle <handle> --record-key <record key> [--limit <number>] [--next] [--output-id]
       or
       bsky feed --did <did> --record-key <record key> [--limit <number>] [--next] [--output-id]
       or
       bsky feed [--url] <bsky.app feed URL> [--limit <number>] [--next] [--output-id]

parameters:
  --actor <handle or did>
    Specify Bluesky handle or DID for custom feed (feed generator) creator. Default handle domain (.bsky.social) can be omitted.

  --record-key <record key>
    Specify record key for part of custom feed (feed generator) 

  --handle <handle>
    Specify Bluesky handle for custom feed (feed generator) creator. Default handle domain (.bsky.social) can be omitted.

  --did <did>
    Specify DID of account for custom feed (feed generator) creator.

  --url <bsky.app feed URL>
    Specify URL of custom feed (feed generator) handled by bsky.app (https://bsky.app/profile/<handle or did>/feed/<record key>).

  --limit <number>
    Specify limit number (default 50) of output feeds (from 1 to 100).

  --next
    Output next feeds from previous feed command.

  --output-id
    Output identifier of AT protocol (uri, cid)

note:
  you must have started a Bluesky session with the login command.
EOS

  debug 'output_help_feed' 'END'
}

output_help_author_feed()
{
  debug 'output_help_author_feed' 'START'

  cat << 'EOS'
bsky author-feed help

usage: bsky author-feed --actor <handle or did> [--limit <number>] [--next] [--filter <filter>] [--output-id]
       or
       bsky author-feed --handle <handle> [--limit <number>] [--next] [--filter <filter>] [--output-id]
       or
       bsky author-feed --did <did> [--limit <number>] [--next] [--filter <filter>] [--output-id]

parameters:
  --actor <handle or did>
    Specify Bluesky handle or DID for custom feed (feed generator) creator. Default handle domain (.bsky.social) can be omitted.

  --handle <handle>
    Specify Bluesky handle for custom feed (feed generator) creator. Default handle domain (.bsky.social) can be omitted.

  --did <did>
    Specify DID of account for custom feed (feed generator) creator.

  --limit <number>
    Specify limit number (default 50) of output feeds (from 1 to 100).

  --next
    Output next feeds from previous author-feed command.

  --filter <filter>
    Specify type of filter for output posts.
    filter:
      posts-with-replies (default)
      posts-no-replies
      posts-with-media
      posts-and-author-threads

  --output-id
    Output identifier of AT protocol (uri, cid)

note:
  you must have started a Bluesky session with the login command.
EOS

  debug 'output_help_author_feed' 'END'
}

output_help_post()
{
  debug 'output_help_post' 'START'

  cat << 'EOS'
bsky post help

usage: bsky post --text '<text>'

parameters:
  --text '<text>'
    Specify text for post.

note:
  you must have started a Bluesky session with the login command.
EOS

  debug 'output_help_post' 'END'
}

output_help_reply()
{
  debug 'output_help_reply' 'START'

  cat << 'EOS'
bsky reply help

usage: bsky reply --index <view index> --text '<text>'
       or
       bsky reply --uri <uri> --cid <cid> --text '<text>'

parameters:
  --index <index>
    Specify the index number pointing to the feed to be replied to.
    The index string is output as "[ViewIndex:<index string>]" using the feed output command.

  --uri <uri>
  --cid <cid>
    Specify the AT URI and CID pointing to the feed to be replied to.
    The AT URI and CID will be output by specifying the "--output-id" option with te feed output command.

  --text '<text>'
    Specify text for post.

note:
  you must have started a Bluesky session with the login command.
EOS

  debug 'output_help_reply' 'END'
}

output_help_repost()
{
  debug 'output_help_repost' 'START'

  cat << 'EOS'
bsky repost help

usage: bsky repost --index <view index>
       or
       bsky repost --uri <uri> --cid <cid>

parameters:
  --index <view index>
    Specify the index number pointing to the feed to be reposted to.
    The index string is output as "[ViewIndex:<index string>]" using the feed output command.

  --uri <uri>
  --cid <cid>
    Specify the AT URI and CID pointing to the feed to be reposted to.
    The AT URI and CID will be output by specifying the "--output-id" option with te feed output command.

note:
  you must have started a Bluesky session with the login command.
EOS

  debug 'output_help_repost' 'END'
}

output_help_quote()
{
  debug 'output_help_quote' 'START'

  cat << 'EOS'
bsky quote help

usage: bsky quote --index <view index> --text '<text>'
       or
       bsky quote --uri <uri> --cid <cid> --text '<text>'

parameters:
  --index <view index>
    Specify the index number pointing to the feed to be quoted to.
    The index string is output as "[ViewIndex:<index string>]" using the feed output command.

  --uri <uri>
  --cid <cid>
    Specify the AT URI and CID pointing to the feed to be quoted to.
    The AT URI and CID will be output by specifying the "--output-id" option with te feed output command.

  --text '<text>'
    Specify text for post.

note:
  you must have started a Bluesky session with the login command.
EOS

  debug 'output_help_quote' 'END'
}

output_help_like()
{
  debug 'output_help_like' 'START'

  cat << 'EOS'
bsky like help

usage: bsky like --index <view index>
       or
       bsky like --uri <uri> --cid <cid>

parameters:
  --index <view index>
    Specify the index number pointing to the feed to be liked to.
    The index string is output as "[ViewIndex:<index string>]" using the feed output command.

  --uri <uri>
  --cid <cid>
    Specify the AT URI and CID pointing to the feed to be liked to.
    The AT URI and CID will be output by specifying the "--output-id" option with te feed output command.

note:
  you must have started a Bluesky session with the login command.
EOS

  debug 'output_help_like' 'END'
}

output_help_thread()
{
  debug 'output_help_thread' 'START'

  cat << 'EOS'
bsky thread help

usage: bsky thread --index <view index> [--depth <number>] [--parent-height <number>] [--output-id]
       or
       bsky thread --uri <uri> [--depth <number>] [--parent-height <number>] [--output-id]

parameters:
  --index <view index>
    Specify the index string pointing to the feed to be show thread to.
    The index string is output as "[ViewIndex:<index string>]" using the feed output command.

  --uri <uri>
    Specify the AT URI pointing to the feed to be show thread to.
    The AT URI will be output by specifying the "--output-id" option with te feed output command.

  --depth <number>
    Specify show levels (default 6) of reply depth (from 1 to 1000).

  --parent-height <number>
    Specify show levels (default 80) of parent post to include (from 1 to 1000).

  --output-id
    Output identifier of AT protocol (uri, cid).

note:
  you must have started a Bluesky session with the login command.
EOS

  debug 'output_help_thread' 'END'
}

output_help_profile()
{
  debug 'output_help_profile' 'START'

  cat << 'EOS'
bsky author-feed help

usage: bsky profile --actor <handle or did> [--output-id]
       or
       bsky profile --handle <handle> [--output-id]
       or
       bsky profile --did <did> [--output-id]
       or
       bsky profile [--output-id]

parameters:
  --actor <handle or did>
    Specify Bluesky handle or DID for custom feed (feed generator) creator. Default handle domain (.bsky.social) can be omitted.

  --handle <handle>
    Specify Bluesky handle for custom feed (feed generator) creator. Default handle domain (.bsky.social) can be omitted.

  --did <did>
    Specify DID of account for custom feed (feed generator) creator.

  --output-id
    Output identifier of AT protocol (uri, cid)

note:
  if --actor, --handle, and --did are all omitted, the current session account will be targeted.
  you must have started a Bluesky session with the login command.
EOS

  debug 'output_help_profile' 'END'
}

output_help_pref()
{
  debug 'output_help_pref' 'START'

  cat << 'EOS'
bsky pref help

usage: bsky pref [--group <preference group>] [--item <preference item>] [--output-id]

parameters:
  --group <preference group>[,<preference group>...]
    Specify preference group.
    If parameter --item is omitted, all items under the group will be targeted.
    Unconfigured (unset) items are not displayed.
    preference group:
      adult-content
      content-label
      saved-feeds
      personal-details
      feed-view
      thread-view
      interests
      muted-words
      hidden-posts
  
  --item <preference item>[,<preference item>...]
    Specify preference item.
    If this parameter value is specified in the format '<group>.<item>', the --group parameter must not specified.
    If this parameter value is specified in the format '<item>', only one --group parameter can be specified.
    preference item:
      (items description is under construction)

EOS
  debug 'output_help_pref' 'END'
}

output_help_info()
{
  debug 'output_help_info' 'START'

  cat << 'EOS'
bsky info help

usage: bsky info <subcommand>

subcommand:
  session
    show session informations.

  meta
    show meta informations.

To see command help:
  bsky info <subcommand> help
EOS

  debug 'output_help_info' 'END'
}

output_help_info_session()
{
  debug 'output_help_info_session' 'START'

  cat << 'EOS'
bsky info help

usage: bsky info session [parameters]

parameters:
  --all
    show all session informations.

  --which
    show session information stored file path.

  --status
    show session status (login or not login).

  --login
    show login timestamp.

  --refresh
    show session latest refresh timestamp.

  --handle
    show login handle.

  --did
    show login did.

  --index
    show current index for some commands.
    show with IDs if '--output-id' option specified.
  
  --cursor
    show current cursor for paginate.
  
  --output-id
    output IDs for some paramaters.

note:
  show all session informations if parameters not specified.
EOS

  debug 'output_help_info_session' 'END'
}

output_help_info_meta()
{
  debug 'output_help_info_meta' 'START'

  cat << 'EOS'
bsky info help

usage: bsky info meta [parameters]

parameters:
  --all
    show all meta informations.

  --path
    show path informations.

  --config
    show configurations.

  --profile
    show session active profiles.

note:
  show all session informations if parameters not specified.
EOS

  debug 'output_help_info_meta' 'END'
}

output_help_version()
{
  debug 'output_help_version' 'START'


  cat << 'EOS'
bsky version help

usage: bsky version
EOS

  debug 'output_help_version' 'END'
}

parse_parameters_login()
{
  debug 'parse_parameters_login' 'START'

  # parameter may include a password
  debug_mode_suppress
  parse_parameters '--handle:1 --password:1' "$@"
  debug_mode_restore

  # dynamic assignment in parse_parameters
  # shellcheck disable=SC2154
  PARSED_PARAM_HANDLE="${PARSED_PARAM_KEYVALUE_handle}"
  # shellcheck disable=SC2154
  PARSED_PARAM_PASSWORD="${PARSED_PARAM_KEYVALUE_password}"

  debug 'parse_parameters_login' 'END'
}

parse_global_option()
{
  debug 'parse_global_option' 'START'

  # if the subsequent command is 'login', parameter may include a password
  debug_mode_suppress
  parse_parameters '-P:1 --profile:1 --session-refresh:0 --version:0' "$@"
  options=$?
  debug_mode_restore
  
  if [ -n "${PARSED_PARAM_KEYVALUE_P}" ]
  then
    BSKYSHCLI_GLOBAL_OPTION_PROFILE="${PARSED_PARAM_KEYVALUE_P}"
  elif [ -n "${PARSED_PARAM_KEYVALUE_profile}" ]
  then
    BSKYSHCLI_GLOBAL_OPTION_PROFILE="${PARSED_PARAM_KEYVALUE_profile}"
  fi

  if [ -n "${BSKYSHCLI_GLOBAL_OPTION_PROFILE}" ]
  then
    # to pass the value to the API script executing the command at api_core()
    export BSKYSHCLI_GLOBAL_OPTION_PROFILE
    verify_profile_name "${BSKYSHCLI_GLOBAL_OPTION_PROFILE}"
  fi

  if [ -n "${PARSED_PARAM_KEYONLY_session_refresh}" ]
  then
    BSKYSHCLI_GLOBAL_OPTION_SESSION_REFRESH='defined'
  fi

  if [ -n "${PARSED_PARAM_KEYONLY_version}" ]
  then
    command_version
    exit 0
  fi

  debug 'parse_global_option' 'END'

  return "${options}"
}

interact_string()
{
  param_description="$1"
  param_prompt="$2"
  param_is_secret="$3"

  debug 'interact_string' 'START'
  debug 'interact_string' "param_description:${param_description}"
  debug 'interact_string' "param_prompt:${param_prompt}"
  debug 'interact_string' "param_is_secret:${param_is_secret}"

  if [ -n "${param_description}" ]
  then
    _pn "${param_description}"
  fi
  if [ -n "${param_prompt}" ]
  then
    prompt="${param_prompt}: "
  else
    prompt='> '
  fi
  _p "${prompt}"
  if [ "${param_is_secret}" -eq 0 ]
  then
    stty -echo
  fi
  # -r option recommendation disable for compatible with Solaris sh
  # shellcheck disable=SC2162
  read RESULT_INTERACT_STRING
  if [ "${param_is_secret}" -eq 0 ]
  then
    stty echo
    _pn ''
  fi

  debug 'interact_string' 'END'
}

interact_login_2FA()
{
  param_handle="$1"
  param_password="$2"

  debug 'interact_login_2FA' 'START'

  interact_string 'input sign in code has been sent to your email address' 'code' 1
  auth_factor_token="${RESULT_INTERACT_STRING}"
  core_create_session "${param_handle}" "${param_password}" "${auth_factor_token}"
  status=$?
  case $status in
    0)
      read_session_file
      _pn "login session of ${SESSION_HANDLE}"
      ;;
  esac

  debug 'interact_login_2FA' 'END'

  return $status
}

command_login()
{
  debug 'command_login' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_login
  else
    parse_parameters_login "$@"
    if [ -n "${PARSED_PARAM_HANDLE}" ]
    then
      handle="${PARSED_PARAM_HANDLE}"
    else
      interact_string 'input Bluesky handle' 'handle' 1
      handle="${RESULT_INTERACT_STRING}"
    fi

    if [ -n "${PARSED_PARAM_PASSWORD}" ]
    then
      password="${PARSED_PARAM_PASSWORD}"
    else
      interact_string "input password of ${handle} (no echo back)" 'password' 0
      password="${RESULT_INTERACT_STRING}"
    fi

    core_create_session "${handle}" "${password}"
    status=$?
    case $status in
      0)
        read_session_file
        _pn "login session of ${SESSION_HANDLE}"
        ;;
      3)
        # 2FA token required
        status=1
        until [ $status -eq 0 ]
        do
          interact_login_2FA "${handle}" "${password}"
          status=$?
        done
        ;;
    esac
  fi

  debug 'command_login' 'END'

  return $status
}

command_logout()
{
  debug 'command_logout' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_logout
  else
    read_session_file
    if [ -n "${SESSION_HANDLE}" ]
    then
      core_delete_session
      _pn "logout session of ${SESSION_HANDLE}"
    else
      error 'session not found'
    fi
  fi

  debug 'command_logout' 'END'

  return 0
}

command_timeline()
{
  debug 'command_timeline' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_timeline
  else
    parse_parameters '--limit:1 --next:0 --output-id:0' "$@"
    if [ -n "${PARSED_PARAM_KEYVALUE_limit}" ]
    then
      verify_numeric_range 'limit' "${PARSED_PARAM_KEYVALUE_limit}" 1 100
      limit=$?
    else
      limit=''
    fi
    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    core_get_timeline '' "${limit}" "${PARSED_PARAM_KEYONLY_next}" "${PARSED_PARAM_KEYONLY_output_id}"
  fi

  debug 'command_timeline' 'END'

  return 0
}

command_feed()
{
  debug 'command_feed' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_feed
  else
    if core_is_feed_generator "$1"
    then
      naked_feed_generator="$1"
      shift
    fi

    parse_parameters '--actor:1 --record-key:1 --handle:1 --did:1 --url:1 --limit:1 --next:0 --output-id:0' "$@"

    if [ -n "${naked_feed_generator}" ]
    then
      if [ -n "${PARSED_PARAM_KEYVALUE_url}" ]
      then
        error 'url parameter is specify only one'
      fi
      url="${naked_feed_generator}"
    else
      url="${PARSED_PARAM_KEYVALUE_url}"
    fi

    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    verify_exclusive 0 '--actor --handle --did --url', "${PARSED_PARAM_KEYVALUE_actor}" "${PARSED_PARAM_KEYVALUE_handle}" "${PARSED_PARAM_KEYVALUE_did}" "${url}"

    did=`core_resolve_actor "${PARSED_PARAM_KEYVALUE_actor}" "${PARSED_PARAM_KEYVALUE_handle}" "${PARSED_PARAM_KEYVALUE_did}"`
    status=$?
    if [ $status -ne 0 ]
    then
      error 'feed command error occured'
    fi

    if [ -n "${did}" ] && [ -z "${PARSED_PARAM_KEYVALUE_record_key}" ]
    then
      error 'parameter --actor/--handle/--did must be specified --record-key'
    fi

    if [ -n "${PARSED_PARAM_KEYVALUE_limit}" ]
    then
      verify_numeric_range 'limit' "${PARSED_PARAM_KEYVALUE_limit}" 1 100
      limit=$?
    else
      limit=''
    fi

    core_get_feed "${did}" "${PARSED_PARAM_KEYVALUE_record_key}" "${url}" "${limit}" "${PARSED_PARAM_KEYONLY_next}" "${PARSED_PARAM_KEYONLY_output_id}"
  fi

  debug 'command_feed' 'END'
}

command_author_feed()
{
  debug 'command_author_feed' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_author_feed
  else
    parse_parameters '--actor:1 --handle:1 --did:1 --limit:1 --next:0 --filter:1 --output-id:0' "$@"

    verify_exclusive 0 '--actor --handle --did', "${PARSED_PARAM_KEYVALUE_actor}" "${PARSED_PARAM_KEYVALUE_handle}" "${PARSED_PARAM_KEYVALUE_did}"

    did=`core_resolve_actor "${PARSED_PARAM_KEYVALUE_actor}" "${PARSED_PARAM_KEYVALUE_handle}" "${PARSED_PARAM_KEYVALUE_did}"`
    status=$?
    if [ $status -ne 0 ]
    then
      error 'author-feed command error occured'
    fi

    if [ -n "${PARSED_PARAM_KEYVALUE_limit}" ]
    then
      verify_numeric_range 'limit' "${PARSED_PARAM_KEYVALUE_limit}" 1 100
      limit=$?
    else
      limit=''
    fi

    if [ -n "${PARSED_PARAM_KEYVALUE_filter}" ]
    then
      case $PARSED_PARAM_KEYVALUE_filter in
        posts-with-replies|posts-no-replies|posts-with-media|posts-and-author-threads)
          filter=`_p "${PARSED_PARAM_KEYVALUE_filter}" | sed 's/-/_/g'`
          ;;
        *)
          error "--filter value ${PARSED_PARAM_KEYVALUE_filter} is not found. see 'bsky author-feed help'"
          ;;
      esac
    else
      filter=''
    fi
    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    core_get_author_feed "${did}" "${limit}" "${PARSED_PARAM_KEYONLY_next}" "${filter}" "${PARSED_PARAM_KEYONLY_output_id}"
  fi

  debug 'command_author_feed' 'END'

  return 0
}

command_post()
{
  debug 'command_post' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_post
  else
    parse_parameters '--text:1' "$@"
    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    post_text="${PARSED_PARAM_KEYVALUE_text}"
    if [ -z "${post_text}" ]
    then
      error "parameter --text '<text>' not specified"
    fi
    core_post "${post_text}"
  fi

  debug 'command_post' 'END'
}

command_reply()
{
  debug 'command_reply' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_reply
  else
    parse_parameters '--index:1 --uri:1 --cid:1 --text:1' "$@"
    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    view_index="${PARSED_PARAM_KEYVALUE_index}"
    # shellcheck disable=SC2154
    uri="${PARSED_PARAM_KEYVALUE_uri}"
    # shellcheck disable=SC2154
    cid="${PARSED_PARAM_KEYVALUE_cid}"
    post_text="${PARSED_PARAM_KEYVALUE_text}"
    if [ -n "${view_index}" ]
    then
      if [ -n "${uri}" ] || [ -n "${cid}" ]
      then
        error "--index and --uri/--cid are exclusive"
      fi
      core_get_feed_view_index "${view_index}"
      uri="${FEED_VIEW_INDEX_ELEMENT_URI}"
      cid="${FEED_VIEW_INDEX_ELEMENT_CID}"
    else
      if [ -z "${uri}" ] || [ -z "${cid}" ]
      then
        error "parameter must be specify --index or --uri/--cid"
      fi
    fi
    if [ -z "${post_text}" ]
    then
      error "parameter --text '<text>' not specified"
    fi
    core_reply "${uri}" "${cid}" "${post_text}"
  fi

  debug 'command_reply' 'END'
}

command_repost()
{
  debug 'command_repost' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_repost
  else
    parse_parameters '--index:1 --uri:1 --cid:1' "$@"
    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    view_index="${PARSED_PARAM_KEYVALUE_index}"
    # shellcheck disable=SC2154
    uri="${PARSED_PARAM_KEYVALUE_uri}"
    # shellcheck disable=SC2154
    cid="${PARSED_PARAM_KEYVALUE_cid}"
    if [ -n "${view_index}" ]
    then
      if [ -n "${uri}" ] || [ -n "${cid}" ]
      then
        error "--index and --uri/--cid are exclusive"
      fi
      core_get_feed_view_index "${view_index}"
      uri="${FEED_VIEW_INDEX_ELEMENT_URI}"
      cid="${FEED_VIEW_INDEX_ELEMENT_CID}"
    else
      if [ -z "${uri}" ] || [ -z "${cid}" ]
      then
        error "parameter must be specify --index or --uri/--cid"
      fi
    fi
    core_repost "${uri}" "${cid}"
  fi

  debug 'command_repost' 'END'
}

command_quote()
{
  debug 'command_quote' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_quote
  else
    parse_parameters '--index:1 --uri:1 --cid:1 --text:1' "$@"
    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    view_index="${PARSED_PARAM_KEYVALUE_index}"
    # shellcheck disable=SC2154
    uri="${PARSED_PARAM_KEYVALUE_uri}"
    # shellcheck disable=SC2154
    cid="${PARSED_PARAM_KEYVALUE_cid}"
    post_text="${PARSED_PARAM_KEYVALUE_text}"
    if [ -n "${view_index}" ]
    then
      if [ -n "${uri}" ] || [ -n "${cid}" ]
      then
        error "--index and --uri/--cid are exclusive"
      fi
      core_get_feed_view_index "${view_index}"
      uri="${FEED_VIEW_INDEX_ELEMENT_URI}"
      cid="${FEED_VIEW_INDEX_ELEMENT_CID}"
    else
      if [ -z "${uri}" ] || [ -z "${cid}" ]
      then
        error "parameter must be specify --index or --uri/--cid"
      fi
    fi
    if [ -z "${post_text}" ]
    then
      error "parameter --text '<text>' not specified"
    fi
    core_quote "${uri}" "${cid}" "${post_text}"
  fi

  debug 'command_quote' 'END'
}

command_like()
{
  debug 'command_like' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_like
  else
    parse_parameters '--index:1 --uri:1 --cid:1' "$@"
    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    view_index="${PARSED_PARAM_KEYVALUE_index}"
    # shellcheck disable=SC2154
    uri="${PARSED_PARAM_KEYVALUE_uri}"
    # shellcheck disable=SC2154
    cid="${PARSED_PARAM_KEYVALUE_cid}"
    if [ -n "${view_index}" ]
    then
      if [ -n "${uri}" ] || [ -n "${cid}" ]
      then
        error "--index and --uri/--cid are exclusive"
      fi
      core_get_feed_view_index "${view_index}"
      uri="${FEED_VIEW_INDEX_ELEMENT_URI}"
      cid="${FEED_VIEW_INDEX_ELEMENT_CID}"
    else
      if [ -z "${uri}" ] || [ -z "${cid}" ]
      then
        error "parameter must be specify --index or --uri/--cid"
      fi
    fi
    core_like "${uri}" "${cid}"
  fi

  debug 'command_like' 'END'
}

command_thread()
{
  debug 'command_thread' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_thread
  else
    parse_parameters '--index:1 --uri:1 --depth:1 --parent-height:1 --output-id:0' "$@"
    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    view_index="${PARSED_PARAM_KEYVALUE_index}"
    # shellcheck disable=SC2154
    uri="${PARSED_PARAM_KEYVALUE_uri}"
    # shellcheck disable=SC2154
    depth="${PARSED_PARAM_KEYVALUE_depth}"
    # shellcheck disable=SC2154
    parent_height="${PARSED_PARAM_KEYVALUE_parent_height}"
    if [ -n "${view_index}" ]
    then
      if [ -n "${uri}" ]
      then
        error "--index and --uri are exclusive"
      fi
      core_get_feed_view_index "${view_index}"
      uri="${FEED_VIEW_INDEX_ELEMENT_URI}"
    else
      if [ -z "${uri}" ]
      then
        error "parameter must be specify --index or --uri"
      fi
    fi
    if [ -n "${depth}" ]
    then
      _isnumeric "${depth}"
      is_numeric=$?
      if [ $is_numeric -ne 0 ]
      then
        error "--depth parameter must be numeric value: ${depth}"
      fi
    fi
    if [ -n "${parent_height}" ]
    then
      _isnumeric "${parent_height}"
      is_numeric=$?
      if [ $is_numeric -ne 0 ]
      then
        error "--parent-height parameter must be numeric value: ${parent_height}"
      fi
    fi
    core_thread "${uri}" "${depth}" "${parent_height}" "${PARSED_PARAM_KEYONLY_output_id}"
  fi

  debug 'command_thread' 'END'
}

command_profile()
{
  debug 'command_profile' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_profile
  else
    parse_parameters '--actor:1 --handle:1 --did:1 --output-id:0 --dump:0' "$@"

    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    if verify_exclusive 1 '--actor --handle --did', "${PARSED_PARAM_KEYVALUE_actor}" "${PARSED_PARAM_KEYVALUE_handle}" "${PARSED_PARAM_KEYVALUE_did}"
    then
      :
    else
      read_session_file
      PARSED_PARAM_KEYVALUE_did="${SESSION_DID}"
    fi

    did=`core_resolve_actor "${PARSED_PARAM_KEYVALUE_actor}" "${PARSED_PARAM_KEYVALUE_handle}" "${PARSED_PARAM_KEYVALUE_did}"`
    status=$?
    if [ $status -ne 0 ]
    then
      error 'profile command error occured'
    fi

    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    core_get_profile "${did}" "${PARSED_PARAM_KEYONLY_output_id}" "${PARSED_PARAM_KEYONLY_dump}"
  fi

  debug 'command_profile' 'END'
}

command_pref()
{
  debug 'command_pref' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_pref
  else
    parse_parameters '--group:1 --item:1 --dump:0' "$@"

    # dynamic assignment in parse_parameters
    # shellcheck disable=SC2154
    core_get_pref "${PARSED_PARAM_KEYVALUE_group}" "${PARSED_PARAM_KEYVALUE_item}" "${PARSED_PARAM_KEYONLY_dump}"
  fi

  debug 'command_pref' 'END'
}

command_info_session()
{
  debug 'command_info_session' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_info_session
  else
    parse_parameters '--all:0 --which:0 --status:0 --login:0 --refresh:0 --handle:0 --did:0 --index:0 --cursor:0 --output-id:0' "$@"
    count_options=$?
    if [ $count_options -eq 0 ]
    then
      PARSED_PARAM_KEYONLY_all='(defined)'
    elif [ $count_options -eq 1 ] && [ -n "${PARSED_PARAM_KEYONLY_output_id}" ]
    then
      PARSED_PARAM_KEYONLY_all='(defined)'
    fi

    read_session_file
    if [ -n "${PARSED_PARAM_KEYONLY_which}" ] || [ -n "${PARSED_PARAM_KEYONLY_all}" ]
    then
      core_info_session_which
    fi
    if [ -n "${PARSED_PARAM_KEYONLY_status}" ] || [ -n "${PARSED_PARAM_KEYONLY_all}" ]
    then
      core_info_session_status
    fi
    if [ -n "${PARSED_PARAM_KEYONLY_login}" ] || [ -n "${PARSED_PARAM_KEYONLY_all}" ]
    then
      core_info_session_login
    fi
    if [ -n "${PARSED_PARAM_KEYONLY_refresh}" ] || [ -n "${PARSED_PARAM_KEYONLY_all}" ]
    then
      core_info_session_refresh
    fi
    if [ -n "${PARSED_PARAM_KEYONLY_handle}" ] || [ -n "${PARSED_PARAM_KEYONLY_all}" ]
    then
      core_info_session_handle
    fi
    if [ -n "${PARSED_PARAM_KEYONLY_did}" ] || [ -n "${PARSED_PARAM_KEYONLY_all}" ]
    then
      core_info_session_did
    fi
    if [ -n "${PARSED_PARAM_KEYONLY_index}" ] || [ -n "${PARSED_PARAM_KEYONLY_all}" ]
    then
      core_info_session_index "${PARSED_PARAM_KEYONLY_output_id}"
    fi
    if [ -n "${PARSED_PARAM_KEYONLY_cursor}" ] || [ -n "${PARSED_PARAM_KEYONLY_all}" ]
    then
      core_info_session_cursor
    fi
  fi

  debug 'command_info_session' 'END'
}

command_info_meta()
{
  debug 'command_info_meta' 'START'

  if [ "$1" = 'help' ]
  then
    output_help_info_meta
  else
    parse_parameters '--all:0 --path:0 --config:0 --profile:0' "$@"
    count_options=$?
    if [ $count_options -eq 0 ]
    then
      PARSED_PARAM_KEYONLY_all='(defined)'
    fi
    
    read_session_file
    if [ -n "${PARSED_PARAM_KEYONLY_path}" ] || [ -n "${PARSED_PARAM_KEYONLY_all}" ]
    then
      core_info_meta_path
    fi
    if [ -n "${PARSED_PARAM_KEYONLY_config}" ] || [ -n "${PARSED_PARAM_KEYONLY_all}" ]
    then
      core_info_meta_config
    fi
    if [ -n "${PARSED_PARAM_KEYONLY_profile}" ] || [ -n "${PARSED_PARAM_KEYONLY_all}" ]
    then
      core_info_meta_profile
    fi
  fi

  debug 'command_info_meta' 'END'
}

command_info()
{
  debug 'command_info' 'START'

  case $1 in
    session)
      shift
      command_info_session "$@"
      ;;
    meta)
      shift
      command_info_meta "$@"
      ;;
    help)
      output_help_info
      ;;
    *)
      output_help_info
      ;;
  esac

  debug 'command_info' 'END'
}

command_version()
{
  debug 'command_version' 'START'

  _pn "bsky (bsky-sh-cli) ${BSKYSHCLI_CLI_VERSION}"

  debug 'command_version' 'END'
}

# entry point

set_timezone

debug 'bsky' 'START'
# CAUTION: command parameters may contain sensitive information such as passwords 
#debug 'bsky' "command parameters: $*"

which curl > /dev/null
CHECK_CURL=$?
which jq > /dev/null
CHECK_JQ=$?
if [ "${CHECK_CURL}" -ne 0 ] || [ "${CHECK_JQ}" -ne 0 ]
then
  if [ "${CHECK_CURL}" -ne 0 ]
  then
    error_msg 'this command requires curl' 
  fi
  if [ "${CHECK_JQ}" -ne 0 ]
  then
    error_msg 'this command requires jq'
  fi
  exit 1
fi

# equal to if ! mkdir...; does not written for compatible with Solaris sh
mkdir -p "${BSKYSHCLI_TOOLS_WORK_DIR}"
result=$?
if [ $result -ne 0 ]
then
  error "cannot make work directory '${BSKYSHCLI_TOOLS_WORK_DIR}'"
fi

parse_global_option "$@"
options=$?
for _ in `seq 1 ${options}`
do
  shift
done

case $1 in
  login)
    shift
    command_login "$@"
    ;;
  logout)
    shift
    command_logout "$@"
    ;;
  timeline)
    shift
    command_timeline "$@"
    ;;
  feed)
    shift
    command_feed "$@"
    ;;
  author-feed)
    shift
    command_author_feed "$@"
    ;;
  post)
    shift
    command_post "$@"
    ;;
  reply)
    shift
    command_reply "$@"
    ;;
  repost)
    shift
    command_repost "$@"
    ;;
  quote)
    shift
    command_quote "$@"
    ;;
  like)
    shift
    command_like "$@"
    ;;
  thread)
    shift
    command_thread "$@"
    ;;
  profile)
    shift
    command_profile "$@"
    ;;
  pref)  # non-public command
    shift
    command_pref "$@"
    ;;
  info)
    shift
    command_info "$@"
    ;;
  help)
    output_help_general
    ;;
  version)
    shift
    command_version "$@"
    ;;
  *)
    output_help_general
    ;;
esac

debug 'bsky' 'END'

exit 0

